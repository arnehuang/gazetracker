<!DOCTYPE html>
<html>
<head>
    <style>
    #balls {
      position:absolute;
      top: 0px;
      left:0px;
    }
  </style>
    <title>Whack A Vole</title>

    <style>*{-webkit-tap-highlight-color: rgba(0, 0, 0, 0);}</style>

    <script type="text/javascript" src="../static/easel.js"></script>
    <script type="text/javascript" src="../static/Tween.js"></script>
    <!--<script type="text/javascript" src="{{url_for('static', filename='vole.js')}}"></script>-->
    <script type="text/javascript" src="../static/vole.js"></script>
    <script type="text/javascript">

        function resize_canvas(){
            canvas = document.getElementById("WhackaVole");

            if (canvas.height < window.innerHeight)
            {
                canvas.height = window.innerHeight-100;
            }

            if (canvas.width  < window.innerWidth)
            {
                canvas.width  = canvas.height*1.7;
            }

            canvas.style.top = "50px";
            canvas.style.left = String((window.innerWidth-canvas.width)/2)+"px";
            canvas.style.position = "absolute";

        }
        function reload(){
        location.reload();
        }

    </script>
</head>

<!--onresize="reload();"-->
<body onload="resize_canvas();Main();" >
<canvas id="WhackaVole"></canvas>

<script type="text/javascript" src="{{url_for('static', filename='d3.v3.min.js')}}"></script>
<script type="text/javascript" src="{{url_for('static', filename='webgazer.js')}}"></script>



<script>

  window.onload = function() {

    var localstorageLabel = 'webgazerGlobalData';
    window.localStorage.setItem(localstorageLabel, null);

    webgazer.setRegression('ridge') /* currently must set regression and tracker */
    .setTracker('clmtrackr')
    .setGazeListener(function(data, clock) {
         //console.log(data);
         if(!data)
          return;

        svg.select("#eyeline1").remove();
        var cl = webgazer.getTracker().clm;

        var line = svg.append("line")
                  .attr("x1",data.x)
                  .attr("y1",data.y)
                  .attr("x2",cl.getCurrentPosition()[27][0])
                  .attr("y2",cl.getCurrentPosition()[27][1])
                  .attr("stroke-width",2)
                  .attr("stroke","red")
                  .attr("id","eyeline1");

        svg.select("#eyeline2").remove();
        var cl = webgazer.getTracker().clm;

        var line = svg.append("line")
                  .attr("x1",data.x)
                  .attr("y1",data.y)
                  .attr("x2",cl.getCurrentPosition()[32][0])
                  .attr("y2",cl.getCurrentPosition()[32][1])
                  .attr("stroke-width",2)
                  .attr("stroke","red")
                  .attr("id","eyeline2");

        svg.select("#predictionSquare").remove();
        var dot = svg.append("rect")
                    .attr("x",data.x)
                    .attr("y",data.y)
                    .attr("width",5)
                    .attr("height",5)
                    .attr("fill","red")
                    .attr("id","predictionSquare");


      })
    .begin()
    .showPredictionPoints(true); /* shows a square every 100 milliseconds where current prediction is */

    var width = window.innerWidth,
    height = window.innerHeight;

    var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("z-index", -99)
    .attr("id","balls");

    function setup() {

      var width = 320;
      var height = 240;
      var topDist = '0px';
      var leftDist = '0px';

      var video = document.getElementById('webgazerVideoFeed');
      video.style.display = 'block';
      video.style.position = 'absolute';
      video.style.top = topDist;
      video.style.left = leftDist;
      video.width = width;
      video.height = height;
      video.style.margin = '0px';
      video.style.zIndex="-1";

      webgazer.params.imgWidth = width;
      webgazer.params.imgHeight = height;

      var overlay = document.createElement('canvas');
      overlay.id = 'overlay';
      overlay.style.position = 'absolute';
      overlay.width = width;
      overlay.height = height;
      overlay.style.top = topDist;
      overlay.style.left = leftDist;
      overlay.style.margin = '0px';

      document.body.appendChild(overlay);

      var cl = webgazer.getTracker().clm;

      function drawLoop() {
        requestAnimFrame(drawLoop);
        overlay.getContext('2d').clearRect(0,0,width,height);
        if (cl.getCurrentPosition()) {
          cl.draw(overlay);
        }
      }
      drawLoop();
    };

    function checkIfReady() {
      if (webgazer.isReady()) {
        setup();
      } else {
        setTimeout(checkIfReady, 100);
      }
    }

    setTimeout(checkIfReady,100);

  };

  window.onbeforeunload = function() {
    //webgazer.end(); //Uncomment if you want to save the data even if you reload the page.
    window.localStorage.clear(); //Comment out if you want to save data across different sessions
  }

  </script>


</body>
</html>